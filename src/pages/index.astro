---
import Layout from "../layouts/Layout.astro";
import Card from "../components/Card/index.astro";

import IntroCard from "../components/IntroCard.astro";
import ContactsCard from "../components/ContactsCard.astro";
import TimeZone from "../components/TimeZoneCard.astro";
import Globe from "../components/Globe";

import PostRow from "../components/Blog/PostRow.astro";
import MyStack from "../components/MyStack.astro";

import { LINKS } from "../lib/constants";
import { fetchSubstackPosts } from "../lib/substack";
import CraftedSonic from "../components/CraftedSonic.astro";

const substackPosts = await fetchSubstackPosts(LINKS.substack, 12).catch(() => []);
---

<script>
  import type { AnimationSequence } from "motion";
  import { loaderAnimation } from "../lib/constants";

  const runEntrance = async () => {
    if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    const cards = document.querySelectorAll(".card");
    if (!cards.length) return;

    const { animate, stagger } = await import("motion");

    const sequence: AnimationSequence = [
      loaderAnimation,
      [
        cards,
        { y: ["80%", "0%"], opacity: [0, 1] },
        {
          type: "spring",
          at: "-0.1",
          delay: stagger(0.12),
        },
      ],
    ];

    animate(sequence);
  };

  const scheduleEntrance = () => {
    if ("requestIdleCallback" in window) {
      requestIdleCallback(runEntrance, { timeout: 1200 });
    } else {
      setTimeout(runEntrance, 150);
    }
  };

  if (document.readyState === "complete" || document.readyState === "interactive") {
    requestAnimationFrame(scheduleEntrance);
  } else {
    window.addEventListener("DOMContentLoaded", scheduleEntrance, { once: true });
  }
</script>

<Layout
  description="Bashir Aminu Bello — health data scientist, AI researcher, and policy advocate using data and law to close equity gaps in health and technology."
  title="Bashir Aminu Bello — Health Data Science & AI"
>
  <main
    class="home-grid text-white mx-auto w-full relative grid gap-3 p-3
      sm:p-5 sm:gap-3
      md:grid-cols-2 md:gap-4 md:p-6
      lg:h-[calc(100dvh-2.5rem)] lg:grid-cols-4 lg:grid-rows-8 lg:gap-6
      max-w-[1500px] 2xl:max-w-[1600px]
      lg:overflow-hidden lg:max-h-[1000px]"
  >
    <!-- HERO -->
    <div class="g-hero">
      <IntroCard />
    </div>

    <!-- CONTACT -->
    <div class="g-contact">
      <ContactsCard />
    </div>

    <!-- TIMEZONES -->
    <div class="g-time">
      <TimeZone />
    </div>

    <!-- COUNTRIES -->
    <div class="g-travel">
      <Card
        colorText="text-white-900"
        href="travel"
        title="Where I've been"
        height="h-full"
      >
        <div class="globe-bg" aria-hidden="true">
          <Globe client:only="solid-js" variant="widget" />
        </div>
        <div class="h-full w-full" />
      </Card>
    </div>

    <!-- ✅ LATEST ARTICLES (panel restored, scroll works, content visible) -->
    <!-- IMPORTANT: no href on Card (avoid anchor wrapper layout bug) -->
    <div class="g-writing">
      <Card title="Latest Articles" height="h-full">
        <a
          class="open-substack"
          href={LINKS.substack}
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Open Substack"
          title="Open Substack"
        >
          ↗
        </a>

        <div class="card-body">
          <div class="card-scroll">
            <PostRow posts={substackPosts} limit={12} />
          </div>
        </div>
      </Card>
    </div>

    <!-- ✅ PROJECTS (scroll inside panel so expanded content never truncates) -->
    <div class="g-projects">
      <Card title="Projects" height="h-full">
        <div class="card-body">
          <div class="card-scroll">
            <MyStack />
          </div>
        </div>
      </Card>
    </div>
  </main>

  <div class="footer-pill-wrap">
    <div class="footer-pill">
      <button class="footer-pill-button" type="button" data-sonic-trigger>
        <img
          src="sonic/sonic.gif"
          alt="Play Green Hill theme"
          width="20"
          height="20"
          loading="lazy"
          decoding="async"
        />
      </button>
      <span>Made by Bashir Aminu Bello · 2026</span>
      <audio data-sonic-audio preload="none">
        <source src="/sonic/theme.mp3" type="audio/mpeg" />
      </audio>
    </div>
  </div>

  <style is:global>
    /* =============================
       GRID: keep symmetry + allow scroll
       ============================= */
    .home-grid > * {
      min-width: 0;
      min-height: 0;
    }

    .g-hero,
    .g-contact,
    .g-time,
    .g-travel,
    .g-writing,
    .g-projects {
      height: 100%;
      min-height: 0;
    }

    /* =============================
       LG placement
       ============================= */
    @media (min-width: 1024px) {
      .g-hero {
        grid-column: 1 / span 3;
        grid-row: 1 / span 3;
      }

      .g-contact {
        grid-column: 4 / span 1;
        grid-row: 1 / span 3;
      }

      .g-time {
        grid-column: 1 / span 1;
        grid-row: 4 / span 2;
      }

      .g-travel {
        grid-column: 1 / span 1;
        grid-row: 6 / span 3;
      }

      .g-writing {
        grid-column: 2 / span 1;
        grid-row: 4 / span 5;
      }

      .g-projects {
        grid-column: 3 / span 2;
        grid-row: 4 / span 5;
      }
    }

    /* =============================
       Countries globe background
       ============================= */
    .g-travel .card {
      position: relative;
      overflow: hidden;
    }

    .globe-bg {
      position: absolute;
      inset: 0;
      z-index: -10;
      pointer-events: none;
      opacity: 0.95;
    }

    .globe-bg canvas,
    .globe-bg svg,
    .globe-bg > * {
      position: absolute;
      inset: 0;
    }

    /* =============================
       Card inner scroll (works even if Card/Content is opinionated)
       ============================= */
    .card-body {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      margin-top: 0.25rem;
    }


    .card-scroll::-webkit-scrollbar {
      width: 10px;
    }
    .card-scroll::-webkit-scrollbar-thumb {
      background: rgba(175, 200, 214, 0.22);
      border-radius: 999px;
    }

    /* Top-right open icon for Substack */
    .open-substack {
      position: absolute;
      top: 14px;
      right: 14px;
      z-index: 20;
      display: inline-flex;
      width: 30px;
      height: 30px;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      text-decoration: none;
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(175, 200, 214, 0.18);
      background: rgba(255, 255, 255, 0.03);
    }

    .open-substack:hover {
      border-color: rgba(56, 189, 248, 0.45);
    }

    .footer-pill-wrap {
      display: flex;
      justify-content: center;
      padding: 0 1.5rem 1.5rem;
    }

    .footer-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(175, 200, 214, 0.18);
      background: rgba(15, 25, 35, 0.55);
      color: rgba(235, 245, 255, 0.78);
      font-size: 0.75rem;
      letter-spacing: 0.01em;
    }

    .footer-pill img {
      display: block;
    }

    .footer-pill-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border: 0;
      background: transparent;
      cursor: pointer;
    }

    .footer-pill-button:focus-visible {
      outline: 2px solid rgba(56, 189, 248, 0.65);
      outline-offset: 2px;
      border-radius: 999px;
    }
  </style>

  <script is:inline>
    (() => {
      const trigger = document.querySelector("[data-sonic-trigger]");
      const audio = document.querySelector("[data-sonic-audio]");
      if (!trigger || !audio) return;

      const warmAudio = () => {
        try {
          audio.load();
        } catch (err) {
          console.debug("Sonic audio could not warm:", err);
        }
      };

      if ("requestIdleCallback" in window) {
        requestIdleCallback(warmAudio, { timeout: 800 });
      } else {
        setTimeout(warmAudio, 400);
      }

      trigger.addEventListener("pointerenter", warmAudio, { once: true, passive: true });

      trigger.addEventListener("click", async () => {
        try {
          audio.currentTime = 0;
          await audio.play();
        } catch (err) {
          console.warn("Sonic audio could not play:", err);
        }
      });
    })();
  </script>
</Layout>
