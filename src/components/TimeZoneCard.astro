---
import Card from "./Card/index.astro";
import {
  getCurrentTimeInMountain,
  getCurrentTimeInSokoto,
  getCurrentTimeInNewYork,
  formatTimeForMountain,
  formatTimeForSokoto,
  formatTimeForNewYork,
} from "../lib/helpers";
---

<!-- Scaled down: smaller min-height + tighter padding + slightly smaller type -->
<Card
  colSpan="md:col-span-1"
  rowSpan="md:row-span-2"
  height="min-h-[170px] sm:min-h-[190px]"
>
  <div class="tz-wrap flex flex-col gap-2">
    <div class="tz-stack flex flex-col gap-2">
      <!-- Edmonton -->
      <div class="tz-row rounded-xl px-3 py-3">
        <div class="flex items-baseline justify-between gap-3">
          <p class="m-0 text-[11px] tracking-wide uppercase tz-label">Edmonton</p>
          <time
            id="tz-mt"
            class="m-0 text-base font-serif tabular-nums whitespace-nowrap tz-time"
            datetime=""
          >
            {formatTimeForMountain(getCurrentTimeInMountain())}
          </time>
        </div>
      </div>

      <!-- Sokoto -->
      <div class="tz-row rounded-xl px-3 py-3">
        <div class="flex items-baseline justify-between gap-3">
          <p class="m-0 text-[11px] tracking-wide uppercase tz-label">Sokoto</p>
          <time
            id="tz-wat"
            class="m-0 text-base font-serif tabular-nums whitespace-nowrap tz-time"
            datetime=""
          >
            {formatTimeForSokoto(getCurrentTimeInSokoto())}
          </time>
        </div>
      </div>

      <!-- New York -->
      <div class="tz-row rounded-xl px-3 py-3">
        <div class="flex items-baseline justify-between gap-3">
          <p class="m-0 text-[11px] tracking-wide uppercase tz-label">New York</p>
          <time
            id="tz-et"
            class="m-0 text-base font-serif tabular-nums whitespace-nowrap tz-time"
            datetime=""
          >
            {formatTimeForNewYork(getCurrentTimeInNewYork())}
          </time>
        </div>
      </div>
    </div>
  </div>
</Card>

<style>
  /* Blue theme without screaming */
  .tz-row {
    border: 1px solid rgba(200, 200, 200, 0.12);
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.04),
        rgba(255, 255, 255, 0.015)
      ),
      rgba(10, 10, 10, 0.12);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.18);
    transition: transform 0.14s ease, border-color 0.14s ease,
      background 0.14s ease;
  }

  .tz-row:hover {
    transform: translateY(-1px);
    border-color: rgba(240, 240, 240, 0.35);
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.07),
        rgba(255, 255, 255, 0.03)
      ),
      rgba(10, 10, 10, 0.14);
  }

  .tz-label {
    color: rgba(210, 215, 220, 0.62);
  }

  .tz-time {
    color: rgba(245, 245, 245, 0.92);
    text-shadow: 0 0 16px rgba(255, 255, 255, 0.08);
  }

  .tz-wrap {
    position: relative;
  }

  .tz-toast {
    position: absolute;
    right: -6px;
    top: -12px;
    transform: translateY(-8px);
    padding: 12px 18px;
    border-radius: 14px;
    border: 1px solid rgba(120, 190, 255, 0.42);
    background: radial-gradient(circle at 24% 24%, rgba(90, 170, 255, 0.22), transparent 45%),
      linear-gradient(135deg, rgba(18, 36, 60, 0.96), rgba(10, 22, 38, 0.98));
    box-shadow:
      0 18px 34px rgba(0, 0, 0, 0.4),
      0 0 32px rgba(90, 170, 255, 0.28);
    color: rgba(235, 245, 255, 0.96);
    font-size: 0.9rem;
    letter-spacing: 0.01em;
    opacity: 0;
    transition: opacity 180ms ease, transform 180ms ease;
    backdrop-filter: blur(12px);
    z-index: 2000;
  }

  .tz-toast.show {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .tz-row {
      transition: none;
    }
  }
</style>

<script is:inline>
  const zones = [
    { id: "tz-mt", tz: "America/Edmonton", label: "Edmonton" },
    { id: "tz-wat", tz: "Africa/Lagos", label: "Sokoto" },
    { id: "tz-et", tz: "America/New_York", label: "New York" },
  ];

  const fmt = (tz) => {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: tz,
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
    }).format(new Date());
  };

  const fmtWithZone = (tz) => {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: tz,
      hour: "numeric",
      minute: "2-digit",
      hour12: true,
      timeZoneName: "short",
    }).format(new Date());
  };

  function tick() {
    const nowISO = new Date().toISOString();
    for (const z of zones) {
      const el = document.getElementById(z.id);
      if (!el) continue;
      el.textContent = fmt(z.tz);
      el.setAttribute("datetime", nowISO);
    }
  }

  tick();
  setInterval(tick, 1000);

  // Click-to-copy all times
  (() => {
    const wrap = document.querySelector(".tz-wrap");
    if (!wrap || !navigator.clipboard) return;

    let toast = null;
    let toastTimer;

    const ensureToast = () => {
      if (toast) return toast;
      toast = document.createElement("div");
      toast.className = "tz-toast";
      toast.hidden = true;
      wrap.appendChild(toast);
      return toast;
    };

    const showToast = (msg) => {
      const t = ensureToast();
      t.textContent = msg;
      t.hidden = false;
      t.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        t.classList.remove("show");
        setTimeout(() => (t.hidden = true), 160);
      }, 1700);
    };

    const handleCopy = async () => {
      const lines = zones.map((z) => `${z.label}: ${fmtWithZone(z.tz)}`);
      try {
        await navigator.clipboard.writeText(lines.join("\\n"));
        showToast("Times copied to clipboard");
      } catch (err) {
        console.debug("Timezone copy failed:", err);
        showToast("Copy blocked");
      }
    };

    wrap.addEventListener("click", (e) => {
      const target = e.target;
      if (!target) return;
      if (target.closest("a, button")) return; // ignore any links/buttons inside
      handleCopy();
    });
  })();
</script>
